import React, { useMemo, useState } from "react";
import { Check, X, HelpCircle, Info } from "lucide-react";

// Simple Card & Button stand-ins (since shadcn isn't actually wired here)
const Card = ({ children }) => (
  <div className="bg-white shadow-lg rounded-2xl p-6 mb-6 border border-gray-100">{children}</div>
);
const Button = ({ children, onClick, variant = "default", className = "" }) => {
  const base =
    "px-4 py-2 rounded-xl text-sm font-medium transition active:scale-[.98]";
  const styles =
    variant === "success"
      ? "bg-green-600 text-white hover:bg-green-700"
      : variant === "danger"
      ? "bg-red-600 text-white hover:bg-red-700"
      : variant === "muted"
      ? "bg-gray-200 text-gray-700 hover:bg-gray-300"
      : variant === "outline"
      ? "border border-gray-300 hover:bg-gray-50"
      : "bg-gray-900 text-white hover:bg-black";
  return (
    <button onClick={onClick} className={`${base} ${styles} ${className}`}>
      {children}
    </button>
  );
};

const chapters = [
  {
    title: "บทที่ 1",
    questions: [
      {
        q: "ความดันสัมบูรณ์ (Absolute Pressure) สามารถหาได้จากผลรวมของความดันบรรยากาศ (Atmospheric Pressure) และความดันเกจ (Gauge Pressure)",
        type: "tf",
        correct: true,
        explain: "ความดันสัมบูรณ์คือผลรวมของความดันบรรยากาศและความดันเกจ",
      },
      {
        q: "กลไกการเกิด Thermal NOₓ เกิดจากการทำปฏิกิริยาของไนโตรเจน (N₂) และออกซิเจน (O₂) ในอากาศที่อุณหภูมิสูง ซึ่งแตกต่างจาก Fuel NOₓ ที่เกิดจากไนโตรเจนที่มีอยู่ในเชื้อเพลิงเอง",
        type: "tf",
        correct: true,
        explain: "Thermal NOₓ เกิดจาก N₂ และ O₂ ในอากาศทำปฏิกิริยากันที่อุณหภูมิสูง ต่างจาก Fuel NOₓ ที่มาจากไนโตรเจนในเชื้อเพลิง",
      },
      {
        q: "ในการคำนวณการเผาไหม้โดยทั่วไป อากาศจะถูกพิจารณาว่ามีออกซิเจน (O₂) 21% และไนโตรเจน (N₂) 79% โดยน้ำหนัก",
        type: "tf",
        correct: false,
        explain: "ค่า 21%/79% เป็นการพิจารณาโดยปริมาตร (by volume) ไม่ใช่โดยน้ำหนัก",
      },
      {
        q: "ปริมาตรโมล (Molar Volume) ของก๊าซ 1 โมล ที่อุณหภูมิ 25 °C และความดัน 1 atm มีค่าเท่ากับ 22.4 ลิตร",
        type: "tf",
        correct: false,
        explain: "22.4 L/mol เป็นค่าสำหรับ STP (0 °C, 1 atm) ที่ 25 °C ปริมาตรโมลจะมากกว่า 22.4 L",
      },
      {
        q: "\"ไอเสียชื้น\" หมายถึง ไอเสียที่รวมน้ำจากเชื้อเพลิงและไอน้ำจากการเผาไหม้เข้าไว้ด้วยกัน",
        type: "tf",
        correct: true,
        explain: "ไอเสียชื้นมีทั้งน้ำจากเชื้อเพลิงและไอน้ำจากการเผาไหม้รวมอยู่ด้วย",
      },
    ],
  },
  {
    title: "บทที่ 2",
    questions: [
      {
        q: "ค่า Capture Velocity ที่เหมาะสมสำหรับการดักจับมลพิษจะขึ้นอยู่กับลักษณะการแพร่กระจายของมลพิษ เช่น ถ้ามลพิษแพร่กระจายอย่างรวดเร็วและมีทิศทาง จะต้องใช้ Capture Velocity ที่สูงขึ้น",
        type: "tf",
        correct: true,
        explain: "ยิ่งมลพิษแพร่กระจายเร็วหรือมีแรงส่งมาก ต้องใช้ Capture Velocity สูงขึ้น",
      },
      {
        q: "องค์ประกอบหลักของระบบระบายอากาศเสียแบบเฉพาะที่ (Local Exhaust Ventilation) เมื่อเรียงตามลำดับการไหลของอากาศส่วนใหญ่จะเป็น: Hood > ท่อดูด > พัดลม > อุปกรณ์บำบัดมลพิษ > ปล่องระบาย",
        type: "tf",
        correct: false,
        explain: "ลำดับที่ถูกต้องคือ Hood > ท่อดูด > อุปกรณ์บำบัดมลพิษ > พัดลม > ปล่องระบาย เพื่อป้องกันพัดลม",
      },
      {
        q: "ในการออกแบบระบบท่อระบายอากาศแบบเฉพาะที่ การคงความเร็วลมในท่อให้ต่ำกว่าค่าแนะนำเป็นสิ่งที่ยอมรับได้หากช่วยประหยัดพลังงานได้มาก โดยที่ยังไม่เกิดการตกค้างของฝุ่นที่มองเห็นได้",
        type: "tf",
        correct: false,
        explain: "ต่ำกว่าค่าแนะนำจะสะสมอุดตันระยะยาว ลดประสิทธิภาพ แม้ระยะสั้นจะยังไม่เห็น",
      },
      {
        q: "การเลือกความเร็วในการจับมลพิษ (Capture Velocity) ที่เหมาะสมเป็นสิ่งสำคัญในการออกแบบ Hood โดยหากมลพิษถูกปล่อยออกมาด้วยความเร็วสูง ก็ควรเลือกใช้ Capture Velocity ที่สูงตามไปด้วย",
        type: "tf",
        correct: true,
        explain: "มลพิษพุ่งแรง ต้องใช้ Capture Velocity สูงพอจะดึงเข้าฮูดทัน",
      },
      {
        q: "อัตราส่วนอากาศ (m) คือสัดส่วนของอากาศที่ใช้จริงต่ออากาศที่ต้องการตามทฤษฎี ซึ่งโดยทั่วไปจะมีค่าน้อยกว่า 1 เพื่อเป็นการประหยัดพลังงาน",
        type: "tf",
        correct: false,
        explain: "m ต้อง ≥ 1 ถ้าน้อยกว่า 1 การเผาไหม้ไม่สมบูรณ์ เกิด CO และควัน",
      },
    ],
  },
  {
    title: "บทที่ 3",
    questions: [
      {
        q: "(T/F) เครื่องควบคุมฝุ่นละอองประเภท Wet Scrubber มีข้อดีคือสามารถกำจัดฝุ่นละอองและก๊าซบางชนิดได้พร้อมกัน แต่มีข้อจำกัดคือทำให้เกิดปัญหาน้ำเสียที่ต้องบำบัดต่อ.",
        type: "tf",
        correct: true,
        explain: "กำจัดได้ทั้งฝุ่นและก๊าซ แต่ก่อให้เกิดน้ำเสียที่ต้องบำบัดต่อ",
      },
      {
        q: "กลไกการแพร่ (Diffusion) เป็นกลไกหลักที่ทำให้เครื่องดักฝุ่นแบบไซโคลน (Cyclone) มีประสิทธิภาพสูงในการดักจับอนุภาคฝุ่นขนาดใหญ่ (มากกว่า 10 ไมครอน)",
        type: "tf",
        correct: false,
        explain: "ไซโคลนเด่นที่แรงเฉื่อยและแรงโน้มถ่วง ส่วน diffusion สำคัญกับอนุภาคเล็กมาก",
      },
      {
        q: "หากฝุ่นที่สะสมบนแผ่นเก็บฝุ่นในเครื่อง EP มีค่าความต้านทานไฟฟ้าสูงเกินไป อาจทำให้เกิด Back Corona ซึ่งส่งผลให้ประสิทธิภาพการเก็บฝุ่นลดลง",
        type: "tf",
        correct: true,
        explain: "ค่าความต้านทานสูงทำให้เกิด back corona ลดประสิทธิภาพ",
      },
      {
        q: "ประสิทธิภาพรวมของเครื่องควบคุมฝุ่นละอองหลายเครื่องที่ต่อกันแบบอนุกรม จะคำนวณโดยการนำประสิทธิภาพย่อยของแต่ละเครื่องมาเฉลี่ยแบบถ่วงน้ำหนัก",
        type: "tf",
        correct: false,
        explain: "หลายเครื่องต่ออนุกรม ไม่ใช่เฉลี่ยถ่วงน้ำหนักแบบหลายขนาดอนุภาคในเครื่องเดียว",
      },
      {
        q: "เครื่องดักฝุ่นแบบไฟฟ้าสถิต (ESP) มีขั้นตอนสำคัญ: Charging, Collecting, Removal",
        type: "tf",
        correct: true,
        explain: "3 ขั้นตอนหลักของ ESP คือ Charging → Collecting → Removal",
      },
    ],
  },
  {
    title: "บทที่ 4",
    questions: [
      {
        q: "ค่าคงที่ของเฮนรี่ (Henry's Law Constant, H) หากมีค่าสูง แสดงว่าก๊าซมลพิษชนิดนั้นสามารถละลายในของเหลวได้ดีมาก",
        type: "tf",
        correct: false,
        explain: "จาก y = Hx ค่า H ต่ำต่างหากที่บ่งชี้ว่าละลายดี",
      },
      {
        q: "ตามประกาศกระทรวงอุตสาหกรรม พ.ศ. 2549 (ฉบับทั่วไป) หากโรงงานใช้เชื้อเพลิง 2 ชนิดผสมกัน คือ ไม้สับ 60% และน้ำมันเตา 40% ค่ามาตรฐาน SO₂ ต้องยึดตามค่าของน้ำมันเตา เพราะมีค่ามาตรฐานสูงกว่า",
        type: "tf",
        correct: false,
        explain: "ให้ยึดตามเชื้อเพลิงที่มีสัดส่วนการใช้มากที่สุด ในกรณีนี้คือไม้สับ 60%",
      },
      {
        q: "การดูดกลืน (Absorption) เป็นกลไกที่ก๊าซมลพิษละลายลงในของเหลว ในขณะที่การดูดซับ (Adsorption) เป็นกลไกที่โมเลกุลของก๊าซมลพิษถูกดูดให้ติดกับผิวของตัวดูดซับ",
        type: "tf",
        correct: true,
        explain: "นิยามตรงตามต้นฉบับ",
      },
      {
        q: "Breakthrough Curve เป็นกราฟที่แสดงการทำงานของชั้นสารดูดซับ โดยมีแกน X เป็นเวลา/ปริมาตร และแกน Y เป็นความเข้มข้นที่ออก ใช้หา Breakthrough Time และความยาว MTZ",
        type: "tf",
        correct: true,
        explain: "ใช้ประเมิน BT time และ MTZ",
      },
      {
        q: "การฟื้นสภาพ (Regenerate) ตัวดูดซับที่อิ่มตัวแล้ว สามารถทำได้โดยการลดอุณหภูมิ หรือเพิ่มความดัน",
        type: "tf",
        correct: false,
        explain: "หลักๆ คือเพิ่มอุณหภูมิหรือ ลดความดัน เพื่อไล่โมเลกุลออก",
      },
    ],
  },
  {
    title: "บทที่ 5",
    questions: [
      {
        q: "ตามกฎหมายไทย ค่าความเข้มกลิ่นที่กำหนดโดยใช้ D/T ถูกเรียกว่า \"หน่วย\" และ D/T = 100 หมายถึง ต้องใช้อากาศ 100 ส่วนต่อตัวอย่าง 1 ส่วนในการเจือจางให้กลิ่นอยู่ในระดับที่เริ่มรู้สึกได้",
        type: "tf",
        correct: true,
        explain: "D/T = 100 คืออากาศ 100 ส่วน ต่อ ตัวอย่าง 1 ส่วน",
      },
      {
        q: "ระบบกำจัดกลิ่นด้วยวิธีชีวภาพ (Biofilter) เหมาะสมกับ VOC เข้มข้นสูงๆ ส่วน Catalytic Oxidation เหมาะกับแก๊สอันตรายที่มีความเข้มข้นต่ำ",
        type: "tf",
        correct: false,
        explain: "Biofilter ไม่เหมาะกับความเข้มสูงมาก ระบบไวต่อการเปลี่ยนแปลง",
      },
      {
        q: "Biofilter มีค่าใช้จ่ายเดินระบบต่ำ ไม่ต้องใช้สารเคมี แต่ไวต่อการเปลี่ยนแปลงและโหลดพิษสูง",
        type: "tf",
        correct: true,
        explain: "ข้อดีและข้อจำกัดตรงตามต้นฉบับ",
      },
      {
        q: "กฎกระทรวง พ.ศ. 2548 บังคับให้โรงงานทุกแห่งตรวจวัดกลิ่นด้วยวิธีดมอย่างสม่ำเสมอ",
        type: "tf",
        correct: false,
        explain: "ตรวจเฉพาะกรณีถูกร้องเรียนหรือสงสัย และครอบคลุมโรงงานบางประเภท",
      },
      {
        q: "Direct Combustion และ Catalytic Oxidation ไม่สามารถกำจัดกลิ่นจากสารอนินทรีย์ที่เผาไหม้ไม่ได้",
        type: "tf",
        correct: true,
        explain: "ข้อจำกัดร่วมของกระบวนการ",
      },
    ],
  },
  {
    title: "บทที่ 6",
    questions: [
      {
        q: "แนวทางการจัดทำบัญชีการปล่อยมลพิษแบบ Top-down Approach คือการเก็บข้อมูลในพื้นที่โดยการสุ่มตัวอย่างแล้วประมาณขยายผลออกไป",
        type: "tf",
        correct: false,
        explain: "Top-down ใช้ข้อมูลภาพรวมแล้วประมาณลงพื้นที่ ไม่ใช่สุ่มในพื้นที่",
      },
      {
        q: "แนวทางการจัดทำบัญชีการปล่อยมลพิษแบบ Bottom-up Approach เหมาะสำหรับประเมินมลพิษภาพรวมประเทศ เพราะใช้ข้อมูลระดับมหภาค",
        type: "tf",
        correct: false,
        explain: "Bottom-up เริ่มจากข้อมูลย่อยแล้วขยายผล ไม่ใช่ข้อมูลมหภาค",
      },
      {
        q: "ข้อมูลสำคัญในบัญชีการปล่อยมลพิษอากาศ (EI) ประกอบด้วยแหล่งกำเนิด (ชนิด/จำนวน) และปริมาณมลพิษที่ปล่อยต่อเวลา",
        type: "tf",
        correct: true,
        explain: "องค์ประกอบข้อมูลหลักของ EI",
      },
      {
        q: "การประมาณการแบบละเอียด (Tier 3) ตาม IPCC จะพิจารณารายละเอียดเทคโนโลยีเตาเผาและอุปกรณ์ควบคุมมลพิษ",
        type: "tf",
        correct: true,
        explain: "Tier 3 พิจารณารายละเอียดเชิงลึก",
      },
      {
        q: "การประมาณการปล่อยมลพิษแบบสมดุลมวล (Material Balance) เหมาะเป็นพิเศษเมื่อสารตั้งต้นสูญเสียไปในไอเสียจำนวนมาก",
        type: "tf",
        correct: true,
        explain: "เหมาะเมื่อมีการสูญเสียสารตั้งต้นไปกับไอเสียมาก",
      },
    ],
  },
  {
    title: "บทที่ 7",
    questions: [
      {
        q: "การเก็บตัวอย่างฝุ่นละอองจากปล่องต้องใช้วิธี Isokinetic sampling เสมอ",
        type: "tf",
        correct: true,
        explain: "เพื่อให้ได้ตัวอย่างแทนจริง",
      },
      {
        q: "ในการเก็บตัวอย่างแบบ Isokinetic หาก Vn ต่ำกว่า Vs ผลวัดฝุ่นจะสูงเกินจริง",
        type: "tf",
        correct: true,
        explain: "ก๊าซเลี้ยวออก แต่ฝุ่นแรงเฉื่อยยังเข้า ทำให้เก็บเกินจริง",
      },
      {
        q: "การวิเคราะห์ก๊าซปล่องตาม U.S. EPA Method 3 ด้วย Orsat Analyzer จะได้ CO₂, SO₂ และ O₂",
        type: "tf",
        correct: false,
        explain: "Orsat ให้ CO₂, O₂ และ CO ไม่ใช่ SO₂",
      },
      {
        q: "ต้องเก็บตัวอย่างหลายจุดบนหน้าตัดปล่องเพราะความเร็วและองค์ประกอบไม่สม่ำเสมอ",
        type: "tf",
        correct: true,
        explain: "หลักการของ Method 1",
      },
      {
        q: "ตาม U.S. EPA Method 5 หาก %Isokinetic = 88% ยังยอมรับได้",
        type: "tf",
        correct: false,
        explain: "ช่วงยอมรับ 90–110% เท่านั้น",
      },
    ],
  },
  {
    title: "บทที่ 8",
    questions: [
      {
        q: "โรงงานที่เข้าข่ายต้องจัดทำรายงานมลพิษอากาศ (แบบ รว.3) จะต้องตรวจวัดค่ามลพิษจากปล่องปีละ 2 ครั้ง",
        type: "tf",
        correct: true,
        explain: "ตรวจทุก 6 เดือน หรือปีละ 2 ครั้ง และยื่นรายงาน รว.3",
      },
      {
        q: "ตามพระราชบัญญัติโรงงาน พ.ศ. 2562 โรงงานจำพวกที่ 2 คือโรงงานที่มีเครื่องจักรตั้งแต่ 75 แรงม้าขึ้นไป หรือคนงานตั้งแต่ 75 คนขึ้นไป และต้องได้รับใบอนุญาตก่อนเริ่มประกอบกิจการ",
        type: "tf",
        correct: false,
        explain: "จำพวกที่ 2 คือไม่เกิน 75 แรงม้า หรือไม่เกิน 75 คน และต้องแจ้ง ไม่ใช่ขออนุญาต",
      },
      {
        q: "กฎหมายควบคุม VOCs พ.ศ. 2565 สำหรับถังกักเก็บ หอเผาทิ้ง และการซ่อมบำรุง บังคับใช้กับโรงงานทุกประเภทที่มีการใช้ VOCs",
        type: "tf",
        correct: false,
        explain: "บังคับเฉพาะ 4 ลำดับ คือ 42, 44, 49, 89",
      },
      {
        q: "ประกาศ พ.ศ. 2565 เรื่อง CEMS บังคับโรงงานทุกประเภททั่วประเทศ",
        type: "tf",
        correct: false,
        explain: "ครอบคลุมทั่วประเทศ แต่บังคับเฉพาะ 13 ประเภทการผลิต",
      },
      {
        q: "ประกาศปี 2547 สำหรับโรงงานผลิต/ส่ง/จำหน่ายไฟฟ้า กำหนดมาตรฐาน CO โดยเฉพาะ",
        type: "tf",
        correct: false,
        explain: "ประกาศปี 2547 กำหนด TSP, SO₂, NOₓ ไม่ครอบคลุม CO",
      },
    ],
  },
];

function Question({ q, index, onAnswer, userAnswer, reveal, correct, explain }) {
  const isCorrect = userAnswer === correct;
  const getVariant = (choice) => {
    if (!reveal) {
      // ก่อนกดเฉลย ให้แสดงปุ่มสีเทาเมื่อผู้ใช้เลือก เพื่อบอกสถานะการเลือกโดยไม่สปอยล์คำตอบ
      return userAnswer === choice ? "muted" : "outline";
    }
    // เมื่อกดเฉลยแล้ว จะแสดงสีเขียว/แดง ตามคำตอบ
    return userAnswer === choice ? (isCorrect ? "success" : "danger") : "outline";
  };
  return (
    <Card>
      <div className="flex items-start gap-3">
        <div className="mt-1 text-gray-400">{index + 1}.</div>
        <div className="flex-1">
          <div className="text-base leading-relaxed">{q}</div>

          <div className="mt-3 flex gap-2">
            <Button
              variant={getVariant(true)}
              onClick={() => onAnswer(true)}
            >
              จริง (T)
            </Button>
            <Button
              variant={getVariant(false)}
              onClick={() => onAnswer(false)}
            >
              เท็จ (F)
            </Button>
            <Button variant="outline" onClick={() => onAnswer(undefined)}>
              ล้างคำตอบ
            </Button>
          </div>

          {reveal && (
            <div className={`mt-4 flex items-start gap-2 ${isCorrect ? "text-green-700" : "text-red-700"}`}>
              {isCorrect ? <Check size={18} /> : <X size={18} />}
              <div className="text-sm">
                <div className="font-semibold">{isCorrect ? "ถูกต้อง" : "ยังไม่ถูก"}</div>
                <div className="opacity-90">{explain}</div>
              </div>
            </div>
          )}
        </div>
      </div>
    </Card>
  );
}

export default function QuizApp() {
  const [answers, setAnswers] = useState(() =>
    chapters.map(ch => ch.questions.map(() => undefined))
  );
  const [revealAll, setRevealAll] = useState(false);

  const score = useMemo(() => {
    let s = 0;
    chapters.forEach((ch, i) => {
      ch.questions.forEach((qq, j) => {
        if (answers[i][j] === qq.correct) s += 1;
      });
    });
    return s;
  }, [answers]);

  const total = useMemo(() => chapters.reduce((a, c) => a + c.questions.length, 0), []);

  const setAns = (ci, qi, val) => {
    setAnswers(prev => {
      const copy = prev.map(arr => arr.slice());
      copy[ci][qi] = val;
      return copy;
    });
  };

  const resetAll = () => {
    setAnswers(chapters.map(ch => ch.questions.map(() => undefined)));
    setRevealAll(false);
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900">
      <div className="max-w-4xl mx-auto px-4 py-8">
        <div className="mb-6">
          <h1 className="text-2xl font-bold">แบบทดสอบคลิกตอบ + เฉลย (รวบรวม)</h1>
          <p className="text-sm text-gray-600 mt-2">
            คลิกเลือก จริง/เท็จ ในแต่ละข้อ แล้วกด “ตรวจคำตอบทั้งหมด” เพื่อดูเฉลย พร้อมคำอธิบาย
          </p>
        </div>

        <Card>
          <div className="flex items-center gap-3">
            <div className="shrink-0">
              <Info size={18} className="text-gray-700" />
            </div>
            <div className="text-sm text-gray-700">
              สรุปคะแนน: <span className="font-semibold">{score}</span> / {total}
            </div>
          </div>
          <div className="mt-4 flex flex-wrap gap-2">
            <Button onClick={() => setRevealAll(true)} className="">ตรวจคำตอบทั้งหมด</Button>
            <Button variant="outline" onClick={() => setRevealAll(false)}>ซ่อนเฉลย</Button>
            <Button variant="danger" onClick={resetAll}>เริ่มใหม่</Button>
          </div>
        </Card>

        {chapters.map((ch, ci) => (
          <div key={ci}>
            <h2 className="text-xl font-semibold mb-3">{ch.title}</h2>
            {ch.questions.map((qq, qi) => (
              <Question
                key={qi}
                index={qi}
                q={qq.q}
                correct={qq.correct}
                explain={qq.explain}
                userAnswer={answers[ci][qi]}
                onAnswer={(v) => setAns(ci, qi, v)}
                reveal={revealAll}
              />
            ))}
          </div>
        ))}

        <div className="mt-10 text-center text-xs text-gray-400">
          อ้างอิงเนื้อหาคำถามตามไฟล์ “รวบรวม.pdf” ที่ผู้ใช้อัปโหลด
        </div>
      </div>
    </div>
  );
}
